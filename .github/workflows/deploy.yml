name: Deploy to ECS Fargate

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (int, stg, prod)'
        required: true
        type: string
      ecr-repository:
        description: 'ECR repository name (e.g., app/iam-ms)'
        required: true
        type: string
      image-tag:
        description: 'Image tag to deploy (e.g., sha-abc1234)'
        required: true
        type: string
      cluster-name:
        description: 'ECS cluster name'
        required: true
        type: string
      service-name:
        description: 'ECS service name'
        required: true
        type: string
      task-definition-family:
        description: 'Task definition family name'
        required: true
        type: string
      container-name:
        description: 'Container name in task definition'
        required: true
        type: string
      wait-for-stability:
        description: 'Wait for service stability'
        required: false
        type: boolean
        default: true
    secrets:
      AWS_ROLE_TO_ASSUME:
        description: 'AWS IAM Role ARN for OIDC'
        required: true

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 857736876208.dkr.ecr.eu-west-1.amazonaws.com

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition "${{ inputs.task-definition-family }}" \
            --query 'taskDefinition' \
            > task-definition.json

          # Remove fields not accepted by register-task-definition
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            task-definition.json > clean-task-definition.json

      - name: Update container image
        run: |
          IMAGE_URI="${{ env.ECR_REGISTRY }}/${{ inputs.ecr-repository }}:${{ inputs.image-tag }}"

          jq --arg IMAGE "$IMAGE_URI" \
             --arg CONTAINER "${{ inputs.container-name }}" \
             '.containerDefinitions |= map(if .name == $CONTAINER then .image = $IMAGE else . end)' \
             clean-task-definition.json > new-task-definition.json

          echo "Deploying image: $IMAGE_URI"

      - name: Register new task definition
        id: register
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "task-definition-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Registered: $TASK_DEF_ARN"

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster "${{ inputs.cluster-name }}" \
            --service "${{ inputs.service-name }}" \
            --task-definition "${{ steps.register.outputs.task-definition-arn }}" \
            --force-new-deployment \
            > /dev/null

          echo "Service update initiated for ${{ inputs.service-name }}"

      - name: Wait for service stability
        if: inputs.wait-for-stability
        run: |
          echo "Waiting for service to stabilize..."
          aws ecs wait services-stable \
            --cluster "${{ inputs.cluster-name }}" \
            --services "${{ inputs.service-name }}"
          echo "Service ${{ inputs.service-name }} is stable"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ inputs.ecr-repository }}:${{ inputs.image-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | ${{ inputs.cluster-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Service | ${{ inputs.service-name }} |" >> $GITHUB_STEP_SUMMARY
