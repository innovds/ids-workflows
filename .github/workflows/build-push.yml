name: Build & Push

on:
  workflow_call:
    inputs:
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      build-target:
        description: 'Docker build target for final image'
        required: false
        type: string
        default: 'final'
      ecr-repository:
        description: 'ECR repository name (e.g., app/iam-ms)'
        required: true
        type: string
      platforms:
        description: 'Target platforms'
        required: false
        type: string
        default: 'linux/amd64'
      environment-tag:
        description: 'Environment tag to add (e.g., int)'
        required: false
        type: string
        default: 'int'
    secrets:
      AWS_ROLE_TO_ASSUME:
        description: 'AWS IAM Role ARN for OIDC'
        required: true
      MAVEN_SETTINGS_XML:
        description: 'Maven settings.xml content (base64 encoded)'
        required: false
    outputs:
      image-tag:
        description: 'Image tag (git sha)'
        value: ${{ jobs.build.outputs.image-tag }}
      image-uri:
        description: 'Full image URI'
        value: ${{ jobs.build.outputs.image-uri }}

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 857736876208.dkr.ecr.eu-west-1.amazonaws.com

jobs:
  build:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.sha-tag }}
      image-uri: ${{ steps.meta.outputs.image-uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "sha-tag=sha-$SHA_SHORT" >> $GITHUB_OUTPUT
          echo "image-uri=${{ env.ECR_REGISTRY }}/${{ inputs.ecr-repository }}:sha-$SHA_SHORT" >> $GITHUB_OUTPUT
          echo "Image tag: sha-$SHA_SHORT"

      - name: Prepare Maven settings
        run: |
          mkdir -p ${{ runner.temp }}
          if [ -n "${{ secrets.MAVEN_SETTINGS_XML }}" ]; then
            echo "${{ secrets.MAVEN_SETTINGS_XML }}" | base64 -d > ${{ runner.temp }}/settings.xml
            echo "Maven settings configured from secret"
          else
            echo "No Maven settings provided, using empty file"
            touch ${{ runner.temp }}/settings.xml
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          target: ${{ inputs.build-target }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ inputs.ecr-repository }}:${{ steps.meta.outputs.sha-tag }}
            ${{ env.ECR_REGISTRY }}/${{ inputs.ecr-repository }}:${{ inputs.environment-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: |
            maven_settings=${{ runner.temp }}/settings.xml

      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ inputs.ecr-repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.meta.outputs.sha-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment-tag }}\` |" >> $GITHUB_STEP_SUMMARY
