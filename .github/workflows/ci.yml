name: CI

on:
  workflow_call:
    inputs:
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      test-target:
        description: 'Docker build target for tests'
        required: false
        type: string
        default: 'test'
    secrets:
      MAVEN_SETTINGS_XML:
        description: 'Maven settings.xml content (base64 encoded)'
        required: false

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare Maven settings
        run: |
          mkdir -p ${{ runner.temp }}
          if [ -n "${{ secrets.MAVEN_SETTINGS_XML }}" ]; then
            echo "${{ secrets.MAVEN_SETTINGS_XML }}" | base64 -d > ${{ runner.temp }}/settings.xml
            echo "Maven settings configured from secret"
          else
            echo "No Maven settings provided, using empty file"
            touch ${{ runner.temp }}/settings.xml
          fi

      - name: Run tests (Docker)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          target: ${{ inputs.test-target }}
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: |
            maven_settings=${{ runner.temp }}/settings.xml

      - name: Tests passed
        run: echo "All tests passed!"
