name: Promote Image

on:
  workflow_call:
    inputs:
      ecr-repository:
        description: 'ECR repository name (e.g., app/iam-ms)'
        required: true
        type: string
      source-tag:
        description: 'Source image tag (e.g., sha-abc1234)'
        required: true
        type: string
      target-tag:
        description: 'Target environment tag (e.g., stg, prod)'
        required: true
        type: string
    secrets:
      AWS_ROLE_TO_ASSUME:
        description: 'AWS IAM Role ARN for OIDC'
        required: true
    outputs:
      image-uri:
        description: 'Promoted image URI'
        value: ${{ jobs.promote.outputs.image-uri }}

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 857736876208.dkr.ecr.eu-west-1.amazonaws.com

jobs:
  promote:
    name: Promote ${{ inputs.source-tag }} → ${{ inputs.target-tag }}
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.promote.outputs.image-uri }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Promote image (add tag without rebuild)
        id: promote
        run: |
          REPO="${{ inputs.ecr-repository }}"
          SOURCE_TAG="${{ inputs.source-tag }}"
          TARGET_TAG="${{ inputs.target-tag }}"

          echo "Promoting $REPO:$SOURCE_TAG → $REPO:$TARGET_TAG"

          # Get the manifest of the source image
          MANIFEST=$(aws ecr batch-get-image \
            --repository-name "$REPO" \
            --image-ids imageTag="$SOURCE_TAG" \
            --query 'images[0].imageManifest' \
            --output text)

          if [ "$MANIFEST" == "None" ] || [ -z "$MANIFEST" ]; then
            echo "Error: Source image $REPO:$SOURCE_TAG not found"
            exit 1
          fi

          # Put the manifest with the new tag (no rebuild!)
          aws ecr put-image \
            --repository-name "$REPO" \
            --image-tag "$TARGET_TAG" \
            --image-manifest "$MANIFEST" \
            > /dev/null || echo "Tag may already exist, continuing..."

          IMAGE_URI="${{ env.ECR_REGISTRY }}/$REPO:$TARGET_TAG"
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "Promoted: $IMAGE_URI"

      - name: Promotion summary
        run: |
          echo "## Image Promotion" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ inputs.ecr-repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Tag | ${{ inputs.source-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Tag | ${{ inputs.target-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **No rebuild** | Same image, new tag only |" >> $GITHUB_STEP_SUMMARY
