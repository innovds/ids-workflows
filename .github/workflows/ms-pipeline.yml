name: Microservice Pipeline

on:
  workflow_call:
    inputs:
      service-name:
        description: 'Service name (e.g., iam-ms)'
        required: true
        type: string
      ecr-repository:
        description: 'ECR repository (default: app/{service-name})'
        required: false
        type: string
        default: ''
      aws-account-id:
        description: 'AWS Account ID for ECR'
        required: false
        type: string
        default: '857736876208'
      aws-region:
        description: 'AWS Region'
        required: false
        type: string
        default: 'eu-west-1'
      run-tests:
        description: 'Run tests'
        required: false
        type: boolean
        default: false
      build-push:
        description: 'Build and push image'
        required: false
        type: boolean
        default: false
      deploy-env:
        description: 'Environment to deploy (int, stg, prod, or empty)'
        required: false
        type: string
        default: ''
      image-tag:
        description: 'Image tag for deployment (default: latest)'
        required: false
        type: string
        default: 'latest'
      cluster-prefix:
        description: 'ECS cluster prefix'
        required: false
        type: string
        default: 'app'
      cluster-name:
        description: 'Override ECS cluster name (default: {prefix}-{env}-cluster)'
        required: false
        type: string
        default: ''
      ecs-service-name:
        description: 'Override ECS service name (default: {service}-task-service)'
        required: false
        type: string
        default: ''
      task-family:
        description: 'Override task family (default: {service}-task)'
        required: false
        type: string
        default: ''

    secrets:
      AWS_ROLE_TO_ASSUME:
        required: false
      MAVEN_SETTINGS_XML:
        required: false

    outputs:
      image-tag:
        description: 'Built image tag'
        value: ${{ jobs.build.outputs.image-tag }}

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Build & Push
    if: inputs.build-push
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.value }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate tag
        id: tag
        run: |
          SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "value=sha-$SHA" >> $GITHUB_OUTPUT

      - name: ECR repo
        id: ecr
        run: |
          REPO="${{ inputs.ecr-repository }}"
          [ -z "$REPO" ] && REPO="app/${{ inputs.service-name }}"
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "registry=${{ inputs.aws-account-id }}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com" >> $GITHUB_OUTPUT

      - name: Maven settings
        uses: ids-aws/ids-workflows/actions/maven-settings@main
        id: maven
        with:
          settings-base64: ${{ secrets.MAVEN_SETTINGS_XML }}

      - name: Login to ECR
        uses: ids-aws/ids-workflows/actions/ecr-login@main
        with:
          aws-role: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws-region }}

      - name: Run tests
        if: inputs.run-tests
        uses: ids-aws/ids-workflows/actions/docker-build@main
        with:
          target: test
          push: 'false'
          maven-settings-path: ${{ steps.maven.outputs.settings-path }}

      - name: Build & Push
        uses: ids-aws/ids-workflows/actions/docker-build@main
        with:
          target: final
          push: 'true'
          registry: ${{ steps.ecr.outputs.registry }}
          repository: ${{ steps.ecr.outputs.repo }}
          image-tag: ${{ steps.tag.outputs.value }}
          extra-tags: latest
          maven-settings-path: ${{ steps.maven.outputs.settings-path }}

  deploy:
    name: Deploy ${{ inputs.deploy-env }}
    needs: [build]
    if: always() && inputs.deploy-env != '' && (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ inputs.deploy-env }}

    steps:
      - name: Resolve image
        id: image
        run: |
          TAG="${{ needs.build.outputs.image-tag }}"
          [ -z "$TAG" ] && TAG="${{ inputs.image-tag }}"

          REPO="${{ inputs.ecr-repository }}"
          [ -z "$REPO" ] && REPO="app/${{ inputs.service-name }}"

          REGISTRY="${{ inputs.aws-account-id }}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com"
          echo "uri=$REGISTRY/$REPO:$TAG" >> $GITHUB_OUTPUT

      - name: Resolve ECS names
        id: ecs
        run: |
          # Cluster: override or {prefix}-{env}-cluster
          CLUSTER="${{ inputs.cluster-name }}"
          [ -z "$CLUSTER" ] && CLUSTER="${{ inputs.cluster-prefix }}-${{ inputs.deploy-env }}-cluster"
          echo "cluster=$CLUSTER" >> $GITHUB_OUTPUT

          # Service: override or {service}-task-service
          SERVICE="${{ inputs.ecs-service-name }}"
          [ -z "$SERVICE" ] && SERVICE="${{ inputs.service-name }}-task-service"
          echo "service=$SERVICE" >> $GITHUB_OUTPUT

          # Task: override or {service}-task
          TASK="${{ inputs.task-family }}"
          [ -z "$TASK" ] && TASK="${{ inputs.service-name }}-task"
          echo "task=$TASK" >> $GITHUB_OUTPUT

      - name: Deploy
        uses: ids-aws/ids-workflows/actions/ecs-deploy@main
        with:
          aws-role: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws-region }}
          cluster-name: ${{ steps.ecs.outputs.cluster }}
          service-name: ${{ steps.ecs.outputs.service }}
          task-family: ${{ steps.ecs.outputs.task }}
          container-name: ${{ inputs.service-name }}
          image-uri: ${{ steps.image.outputs.uri }}
