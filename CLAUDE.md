# CLAUDE.md

This file provides guidance to Claude Code when working with this repository.

## Project Purpose

Reusable GitHub Actions workflows for IDS microservices CI/CD. Multi-org support via templates.

## Key Design Decisions

1. **Docker-only builds**: No Java/Maven on runners, all builds inside Dockerfile
2. **Build once, deploy everywhere**: Same image promoted via tag manipulation
3. **Registry-agnostic**: `docker-build` works with any registry (ECR, Docker Hub, GHCR, GCR)
4. **OIDC authentication**: No static AWS credentials
5. **Template-based config**: Placeholders `{{VAR}}` in `templates/`, rendered via `scripts/render.sh`
6. **DRY**: Single unified `docker-build` action for tests and production builds

## Structure

```
templates/              # Sources with {{placeholders}}
├── .github/workflows/
│   ├── ms-ci.yml       # CI for PRs (tests + build validation)
│   └── ms-pipeline.yml # Full pipeline (tests + build + push + deploy)
├── actions/
│   ├── docker-build/   # Unified Docker build action
│   ├── ecr-login/
│   ├── ecs-deploy/
│   └── maven-settings/
└── scripts/

.github/workflows/      # Generated files
actions/                # Generated files
scripts/
├── render.sh           # Generates from templates
├── init-repo.sh        # Generated
├── setup-secrets.sh    # Generated
└── protect-branch.sh   # Branch protection

config.example.sh       # Config template
config.local.sh         # Local config (gitignored)
```

## Shared Workflows

| Workflow | Purpose | Key Inputs |
|----------|---------|------------|
| `ms-ci.yml` | PR validation | `run-tests`, `build-validation` |
| `ms-pipeline.yml` | Full pipeline | `run-tests`, `build-push`, `deploy-env`, `image-tag` |

## Shared Actions

| Action | Purpose | Registry-agnostic |
|--------|---------|-------------------|
| `docker-build` | Build & optionally push | ✅ Yes |
| `ecr-login` | AWS ECR login via OIDC | ECR only |
| `ecs-deploy` | ECS Fargate deploy | AWS only |
| `maven-settings` | Prepare settings.xml | - |

## Development Workflow

```bash
# 1. Edit templates in templates/
# 2. Render for target org
./scripts/render.sh                    # Uses config.local.sh or config.example.sh
./scripts/render.sh config.client.sh   # Uses specific config
```

## Placeholders

| Placeholder | Example |
|-------------|---------|
| `{{ORG_NAME}}` | `ids-aws` |
| `{{AWS_ACCOUNT_ID}}` | `857736876208` |
| `{{AWS_REGION}}` | `eu-west-1` |

## Consumer Repo Workflows

Typical setup for a microservice (generated by `init-repo.sh`):

```yaml
# ci.yml - PR validation (tests only)
uses: ids-aws/ids-workflows/.github/workflows/ms-pipeline.yml@main
with:
  run-tests: true

# build-deploy.yml - Push to main triggers full pipeline
uses: ids-aws/ids-workflows/.github/workflows/ms-pipeline.yml@main
with:
  run-tests: true
  build-push: true
  deploy-env: int

# release.yml - Tag releases/v* triggers full pipeline
uses: ids-aws/ids-workflows/.github/workflows/ms-pipeline.yml@main
with:
  run-tests: true
  build-push: true
  deploy-env: int
```
