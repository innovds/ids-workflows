name: Microservice Pipeline

on:
  workflow_call:
    inputs:
      service-name:
        description: 'Service name (default: repo name)'
        required: false
        type: string
        default: ''
      ecr-repository:
        description: 'ECR repository (default: app/{service-name})'
        required: false
        type: string
        default: ''
      aws-account-id:
        description: 'AWS Account ID for ECR'
        required: false
        type: string
        default: '{{AWS_ACCOUNT_ID}}'
      aws-region:
        description: 'AWS Region'
        required: false
        type: string
        default: '{{AWS_REGION}}'
      run-tests:
        description: 'Run tests'
        required: false
        type: boolean
        default: false
      build-push:
        description: 'Build and push image'
        required: false
        type: boolean
        default: false
      deploy-env:
        description: 'Environment to deploy (int, stg, prod, or empty)'
        required: false
        type: string
        default: ''
      image-tag:
        description: 'Image tag for deployment (default: latest)'
        required: false
        type: string
        default: 'latest'
      cluster-prefix:
        description: 'ECS cluster prefix'
        required: false
        type: string
        default: 'app'
      cluster-name:
        description: 'Override ECS cluster name (default: {prefix}-{env}-cluster)'
        required: false
        type: string
        default: ''
      ecs-service-name:
        description: 'Override ECS service name (default: {service}-task-service)'
        required: false
        type: string
        default: ''
      task-family:
        description: 'Override task family (default: {service}-task)'
        required: false
        type: string
        default: ''
      build-args:
        description: 'Docker build args (multiline KEY=VALUE)'
        required: false
        type: string
        default: ''
      image-tag-prefix:
        description: 'Prefix for image tags (e.g., env name: int, stg, prod)'
        required: false
        type: string
        default: ''

    secrets:
      AWS_ROLE_TO_ASSUME:
        required: false
      MAVEN_SETTINGS_XML:
        required: false

    outputs:
      image-tag:
        description: 'Built image tag'
        value: ${{ jobs.build.outputs.image-tag }}

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Build
    if: inputs.run-tests || inputs.build-push
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.value }}
      service-name: ${{ steps.service.outputs.name }}

    steps:
      - uses: actions/checkout@v4

      - name: Resolve service name
        id: service
        run: |
          NAME="${{ inputs.service-name }}"
          [ -z "$NAME" ] && NAME="${{ github.event.repository.name }}"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Maven settings
        uses: {{ORG_NAME}}/ids-workflows/actions/maven-settings@main
        id: maven
        with:
          settings-base64: ${{ secrets.MAVEN_SETTINGS_XML }}

      - name: Run tests
        if: inputs.run-tests
        uses: {{ORG_NAME}}/ids-workflows/actions/docker-build@main
        with:
          target: test
          push: 'false'
          maven-settings-path: ${{ steps.maven.outputs.settings-path }}
          build-args: ${{ inputs.build-args }}

      - name: Generate tag
        if: inputs.build-push
        id: tag
        run: |
          SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          PREFIX="${{ inputs.image-tag-prefix }}"
          if [ -n "$PREFIX" ]; then
            echo "value=${PREFIX}-sha-$SHA" >> $GITHUB_OUTPUT
            echo "latest=${PREFIX}-latest" >> $GITHUB_OUTPUT
          else
            echo "value=sha-$SHA" >> $GITHUB_OUTPUT
            echo "latest=latest" >> $GITHUB_OUTPUT
          fi

      - name: ECR repo
        if: inputs.build-push
        id: ecr
        run: |
          REPO="${{ inputs.ecr-repository }}"
          [ -z "$REPO" ] && REPO="app/${{ steps.service.outputs.name }}"
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "registry=${{ inputs.aws-account-id }}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com" >> $GITHUB_OUTPUT

      - name: Login to ECR
        if: inputs.build-push
        uses: {{ORG_NAME}}/ids-workflows/actions/ecr-login@main
        with:
          aws-role: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws-region }}

      - name: Build & Push
        if: inputs.build-push
        uses: {{ORG_NAME}}/ids-workflows/actions/docker-build@main
        with:
          target: final
          push: 'true'
          registry: ${{ steps.ecr.outputs.registry }}
          repository: ${{ steps.ecr.outputs.repo }}
          image-tag: ${{ steps.tag.outputs.value }}
          extra-tags: ${{ steps.tag.outputs.latest }}
          maven-settings-path: ${{ steps.maven.outputs.settings-path }}
          build-args: ${{ inputs.build-args }}

  deploy:
    name: Deploy ${{ inputs.deploy-env }}
    needs: [build]
    if: always() && inputs.deploy-env != '' && (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ inputs.deploy-env }}

    steps:
      - name: Resolve service name
        id: service
        run: |
          NAME="${{ needs.build.outputs.service-name }}"
          [ -z "$NAME" ] && NAME="${{ inputs.service-name }}"
          [ -z "$NAME" ] && NAME="${{ github.event.repository.name }}"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Resolve image
        id: image
        run: |
          TAG="${{ needs.build.outputs.image-tag }}"
          if [ -z "$TAG" ]; then
            # No build output, use input with optional prefix
            PREFIX="${{ inputs.image-tag-prefix }}"
            BASE_TAG="${{ inputs.image-tag }}"
            if [ -n "$PREFIX" ]; then
              TAG="${PREFIX}-${BASE_TAG}"
            else
              TAG="$BASE_TAG"
            fi
          fi

          REPO="${{ inputs.ecr-repository }}"
          [ -z "$REPO" ] && REPO="app/${{ steps.service.outputs.name }}"

          REGISTRY="${{ inputs.aws-account-id }}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com"
          echo "uri=$REGISTRY/$REPO:$TAG" >> $GITHUB_OUTPUT

      - name: Resolve ECS names
        id: ecs
        run: |
          # Cluster: override or {prefix}-{env}-cluster
          CLUSTER="${{ inputs.cluster-name }}"
          [ -z "$CLUSTER" ] && CLUSTER="${{ inputs.cluster-prefix }}-${{ inputs.deploy-env }}-cluster"
          echo "cluster=$CLUSTER" >> $GITHUB_OUTPUT

          # Service: override or {service}-task-service
          SERVICE="${{ inputs.ecs-service-name }}"
          [ -z "$SERVICE" ] && SERVICE="${{ steps.service.outputs.name }}-task-service"
          echo "service=$SERVICE" >> $GITHUB_OUTPUT

          # Task: override or {service}-task
          TASK="${{ inputs.task-family }}"
          [ -z "$TASK" ] && TASK="${{ steps.service.outputs.name }}-task"
          echo "task=$TASK" >> $GITHUB_OUTPUT

      - name: Deploy
        uses: {{ORG_NAME}}/ids-workflows/actions/ecs-deploy@main
        with:
          aws-role: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws-region }}
          cluster-name: ${{ steps.ecs.outputs.cluster }}
          service-name: ${{ steps.ecs.outputs.service }}
          task-family: ${{ steps.ecs.outputs.task }}
          container-name: ${{ steps.service.outputs.name }}
          image-uri: ${{ steps.image.outputs.uri }}
